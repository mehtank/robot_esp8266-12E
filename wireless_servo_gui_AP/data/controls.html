<!DOCTYPE html>
<html>
<head>
  <meta charset=utf-8 />
  <title>whooo control robots</title>

  <link rel="stylesheet" type="text/css" href="style.css">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
</head>

<body>
  <h1>Yay Robots!</h1>

  <table>
    <tr>
      <td><button id="leftup"    name="bt" value="UL" class="smbutton">⏫</button></td>
      <td><button id="forward"   name="bt" value="FD" class="button">▲</button></td>
      <td><button id="rightup"   name="bt" value="UR" class="smbutton">⏫</button></td>
    </tr>
    <tr>
      <td><button id="left"      name="bt" value="LT" class="button">◀</button></td>
      <td><button id="center"    name="bt" value="CC" class="smbutton">❤</button></td>
      <td><button id="right"     name="bt" value="RT" class="button">▶</button></td>
    </tr>
    <tr>
      <td><button id="leftdown"  name="bt" value="DL" class="smbutton">⏬</button></td>
      <td><button id="backward"  name="bt" value="BK" class="button">▼</button></td>
      <td><button id="rightdown" name="bt" value="DR" class="smbutton">⏬</button></td>
      <td></td>
    </tr>
  </table>
  <div id="wsRx" class="log"></div>

  <script>
    var btns = document.getElementsByName("bt")
    var i;
    for (i = 0; i < btns.length; i++) {
      btns[i].ontouchstart = function(e) {btnSend(this.value); e.stopPropagation(); e.preventDefault();};
      btns[i].onmousedown = function(e) {btnSend(this.value); e.stopPropagation(); e.preventDefault();};
      btns[i].ontouchend = function() {btnRelease(); e.stopPropagation(); e.preventDefault();}
      btns[i].onmouseup = function() {btnRelease(); e.stopPropagation(); e.preventDefault();}
    }

    document.onkeydown = function(e) {
        e = e || window.event;
        switch(e.which || e.keyCode) {
        case 38:
            btnSend("FD");
            console.log("Up key");
            break;
        case 40:
            btnSend("BK");
            console.log("Down key");
            break;
        case 37:
            btnSend("LT");
            console.log("Left key");
            break;
        case 39:
            btnSend("RT");
            console.log("Right key");
            break;
      }
    }

    document.onkeyup = function(e) {
        btnRelease();
        console.log("Key up");
    }


    var wsRx = document.getElementById("wsRx");
    function wsLog(text) {
      wsRx.innerHTML = text + wsRx.innerHTML;
    }

    var connection = new WebSocket('ws://'+location.hostname+':81/', ['arduino']);
    connection.onopen = function(){
      var timeStr = new Date().toLocaleTimeString();
      var text = "(" + timeStr + ") : CONNECTED <br>";
      connection.send('Connect ' + new Date()); 
      wsLog(text);
    };
    connection.onerror = function(error){
      var timeStr = new Date().toLocaleTimeString();
      var text = "(" + timeStr + ") : EE = " + error + "<br>";
      console.log('WebSocket Error ', error);
      wsLog(text);
    };
    connection.onmessage = function(e){
      var timeStr = new Date().toLocaleTimeString();
      var text = "(" + timeStr + ") : RX = " + e.data + "<br>";
      console.log('Server: ', e.data);
      wsLog(text);
    };



    function btnSend(val) {
      var timeStr = new Date().toLocaleTimeString();
      var text = "(" + timeStr + ") : TX = #" + val + "<br>";
      wsLog(text);

      console.log('Button pressed, sending #'+val); 
      connection.send('#'+val);
    }

    function btnRelease() {
      var timeStr = new Date().toLocaleTimeString();
      var text = "(" + timeStr + ") : TX = #0<br>";
      wsLog(text);

      console.log('Button released'); 
      connection.send('#0');
    }

  </script>


  </body>
</html>
